name: Sync subset

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  check_upstream:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      latest_sha: ${{ steps.check.outputs.latest_sha }}
      default_branch: ${{ steps.check.outputs.default_branch }}
    steps:
      - id: check
        shell: bash
        run: |
          set -euo pipefail
          UPSTREAM_REPO="https://github.com/ShaneeexD/HytaleDevLib.git"
          SHA_FILE=".github/upstream.sha"

          DEFAULT_BRANCH="$(git ls-remote --symref "$UPSTREAM_REPO" HEAD | awk '/^ref:/ {print $2}' | sed 's@refs/heads/@@')"
          LATEST_SHA="$(git ls-remote "$UPSTREAM_REPO" "refs/heads/$DEFAULT_BRANCH" | awk '{print $1}')"

          PREV_SHA=""
          if [[ -f "$SHA_FILE" ]]; then PREV_SHA="$(cat "$SHA_FILE")"; fi

          echo "latest_sha=$LATEST_SHA" >> "$GITHUB_OUTPUT"
          echo "default_branch=$DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"

          if [[ "$LATEST_SHA" == "$PREV_SHA" ]]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

  prepare_sync:
    runs-on: ubuntu-latest
    needs: check_upstream
    if: needs.check_upstream.outputs.changed == 'true'
    steps:
      - uses: actions/checkout@v4

      - shell: bash
        run: |
          set -euo pipefail
          UPSTREAM_REPO="https://github.com/ShaneeexD/HytaleDevLib.git"
          DEFAULT_BRANCH="${{ needs.check_upstream.outputs.default_branch }}"
          SRC_PATH="src/main/java/org/hytaledevlib/lib/"
          DEST_PATH="src/main/java/com/fractalgs/api/"
          SHA_FILE=".github/upstream.sha"
          TMP_DIR="/tmp/upstream-src"
          STAGE_DIR="/tmp/sync-stage"

          rm -rf "$TMP_DIR" "$STAGE_DIR"
          git clone --depth 1 --branch "$DEFAULT_BRANCH" "$UPSTREAM_REPO" "$TMP_DIR"

          mkdir -p "$STAGE_DIR/$DEST_PATH" "$(dirname "$STAGE_DIR/$SHA_FILE")"
          rsync -a --delete --checksum "$TMP_DIR/$SRC_PATH" "$STAGE_DIR/$DEST_PATH"
          echo "${{ needs.check_upstream.outputs.latest_sha }}" > "$STAGE_DIR/$SHA_FILE"

          find "$STAGE_DIR/$DEST_PATH" -type f -name '*.java' -print0 | xargs -0 -I{} bash -c '
            f="$1"
            first="$(head -n 1 "$f" || true)"
            if [[ "$first" == "package org.hytaledevlib.lib;" ]]; then
              sed -i "1s/^package org\.hytaledevlib\.lib;$/package com.fractalgs.api;/" "$f"
            fi
          ' _ {}

          rm -rf "$TMP_DIR"

      - uses: actions/upload-artifact@v4
        with:
          name: sync-payload
          path: |
            /tmp/sync-stage/src/main/java/com/fractalgs/api
            /tmp/sync-stage/.github/upstream.sha

  commit_and_push:
    runs-on: ubuntu-latest
    needs: [check_upstream, prepare_sync]
    if: needs.check_upstream.outputs.changed == 'true'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: sync-payload
          path: /tmp/sync-stage

      - shell: bash
        run: |
          set -euo pipefail
          DEST_PATH="src/main/java/com/fractalgs/api/"
          SHA_FILE=".github/upstream.sha"

          mkdir -p "$DEST_PATH" "$(dirname "$SHA_FILE")"
          rsync -a --delete --checksum "/tmp/sync-stage/$DEST_PATH" "$DEST_PATH"
          cp "/tmp/sync-stage/$SHA_FILE" "$SHA_FILE"
          rm -rf /tmp/sync-stage

          git config user.name  "Fractal Game Studios"
          git config user.email "FractalGameStudios@users.noreply.github.com"

          git add "$DEST_PATH" "$SHA_FILE"

          if git diff --cached --quiet; then
            exit 0
          fi

          CHANGED_JAVA="$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^src/main/java/com/fractalgs/api/.*\.java$' | head -n 12 || true)"

          if [[ -n "$CHANGED_JAVA" ]]; then
            NAMES="$(echo "$CHANGED_JAVA" | xargs -n1 basename | sed 's/\.java$//' | tr '\n' ',' | sed 's/,$//')"
            MSG="API method update: $NAMES"
          else
            MSG="API method update"
          fi

          git commit -m "$MSG"
          git push
